<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>In The Clouds - Template by Bryant Smith</title>
<link rel="stylesheet" type="text/css" href="style.css" />
</head>
<body>

<div id="container">
	<div id="header">
	    <div id="picture">
            <h1>In The Clouds</h1>
            <h2>A template by Bryant Smith</h2>
        </div>
    </div>
    <div id="main">
    <div id="leftcol_container">
    	<div class="leftcol">
        	<h2>Articles</h2>
        	<ul>
            	<li><a href="#">Designing websites </a></li>
            	<li><a href="#">XHTML for dummies</a></li>
            	<li><a href="#">How CSS works</a></li>
            	<li><a href="#">SEO Marketing</a></li>
            	<li><a href="#">Search Submission</a></li>
            	<li><a href="#">All about CMS</a></li>
                <li><a href="#">Designing for Joomla</a></li>
                <li><a href="#">Google Adsense help</a></li>
                <li><a href="#">Marketing Online</a></li>
                <li><a href="#">Pay Per Click</a></li>
                <li><a href="#">Designing XHTML 1.1</a></li>
                <li><a href="#">Making Money Online</a></li>
                <li><a href="#">Web Templates</a></li>
                <li><a href="#">Javascript for all</a></li>
                <li><a href="#">Why jQuery is Great</a></li>
                <li><a href="#">What is Ajax</a></li>
            </ul>
        	<p>&nbsp;</p>
        	<h2>Most Popular</h2>
            <ul>
	            <li><a href="#">Web Templates</a></li>
                <li><a href="#">Javascript for all</a></li>
                <li><a href="#">Why jQuery is Great</a></li>
                <li><a href="#">All about CMS</a></li>
                <li><a href="#">Designing for Joomla</a></li>
                <li><a href="#">Google Adsense help</a></li>
                <li><a href="#">Marketing Online</a></li>
                <li><a href="#">What is Ajax</a></li>
            	<li><a href="#">Designing websites </a></li>
            	<li><a href="#">XHTML for dummies</a></li>
            	<li><a href="#">How CSS works</a></li>
            	<li><a href="#">SEO Marketing</a></li>
            	<li><a href="#">Search Submission</a></li>
                <li><a href="#">Pay Per Click</a></li>
                <li><a href="#">Designing XHTML 1.1</a></li>
                <li><a href="#">Making Money Online</a></li>
            </ul>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <a href="#">Contact Us</a>
      </div>
      <div class="leftcol_bottom"></div>
      </div>
      
        <div id="maincol_container">
        <div class="maincol">          
        <h2>Task</h2>
        <!-- <p>You may use this template in any way you please, <strong>just leave the link at the bottom of the page</strong> back to me.  I love to see how and where my templates are used, so feel free to email me from my site <a href="http://bryantsmith.com">BryantSmith.com</a>.  I also offer professional design, programming, and marketing services, so if you need something a bit more complex, or need help with this template, I'd be happy to help.  I design these templates for free to help those you may not have the time or budget for a full scale custom site, but always appreciate small donations for my services (paypal: paypal@bryantsmith.com).   Thank you, and enjoy the template!<br />
          <br />
        </p>-->
        <p>
          Given the CMS provider data metastore, write a script that downloads all data sets related to the theme "Hospitals".
          <br><br>
          The column names in the csv headers are currently in mixed case with spaces and special characters. Convert all column names to snake_case. (Example: "Patients' rating of the faciilty linear mean score" becomes "patients_rating_of_the_facility_linear_mean_score").
          <br><br>
          The csv files should be downloaded and processed in parallel, and the job should be designed to run every day, but only download files that have been modified since the previous run (need to track runs/metadata).

          <br><br>
          https://data.cms.gov/provider-data-api/1/metastore/schemas/dataset/items
          <br><br>
        </p>
        
        <h2>Submission</h2>
          We will meet each of the requirments specified above, let's first start with the job scheduling/orchestration. Our pipeline will leverage the Python library called 'schedule'.<br><br>

         Additionally, it leverages the pytz library to specify the timezone that the job is scheduled to run. <br><br>
          <!-- ********************************************************************* -->
          <!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">1
2
3
4
5
6
7
8</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">schedule</span>
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">pytz</span> <span style="color: #008800; font-weight: bold">import</span> timezone

schedule<span style="color: #333333">.</span>every()<span style="color: #333333">.</span>day<span style="color: #333333">.</span>at(<span style="background-color: #fff0f0">&quot;12:11:00&quot;</span>, timezone(<span style="background-color: #fff0f0">&quot;America/Chicago&quot;</span>))<span style="color: #333333">.</span>do(main)

<span style="color: #008800; font-weight: bold">while</span> <span style="color: #008800; font-weight: bold">True</span>:
  schedule<span style="color: #333333">.</span>run_pending()
  time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">30</span>)
</pre></td></tr></table></div>
          <!-- ********************************************************************* -->

          <h4>Given the CMS provider data metastore, write a script that downloads all data sets related to the theme "Hospitals".</h4>
          <br><br>
          <h4>The csv files should be downloaded and processed in parallel,...</h4> 
          In order by process the data in parallel, we leverage PySpark:
<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">1
2
3
4</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">pyspark.sql</span> <span style="color: #008800; font-weight: bold">import</span> SparkSession
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">pyspark.sql</span> <span style="color: #008800; font-weight: bold">import</span> Row
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">pyspark.sql.functions</span> <span style="color: #008800; font-weight: bold">import</span> array_contains
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">pyspark.sql</span> <span style="color: #008800; font-weight: bold">import</span> DataFrame
</pre></td></tr></table></div>


<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">get_data</span>() <span style="color: #333333">-&gt;</span> <span style="color: #007020">list</span>:
  <span style="color: #DD4422">&quot;&quot;&quot; Retrieve data via HTTP GET request &quot;&quot;&quot;</span>
  URL <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;http://data.cms.gov/provider-data/api/1/metastore/schemas/dataset/items&quot;</span>
  response <span style="color: #333333">=</span> requests<span style="color: #333333">.</span>get(URL)
  data_dict <span style="color: #333333">=</span> {}
  <span style="color: #008800; font-weight: bold">if</span> response<span style="color: #333333">.</span>status_code <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">200</span>:
      <span style="color: #008800; font-weight: bold">try</span>:
          <span style="color: #008800; font-weight: bold">return</span> response<span style="color: #333333">.</span>json()
      <span style="color: #008800; font-weight: bold">except</span> <span style="color: #FF0000; font-weight: bold">ValueError</span>:
          <span style="color: #007020">print</span>(<span style="background-color: #fff0f0">&quot;Response is not in JSON format&quot;</span>)
  <span style="color: #008800; font-weight: bold">else</span>:
      <span style="color: #007020">print</span>(f<span style="background-color: #fff0f0">&quot;Request failed with status code {response.status.code}&quot;</span>)
</pre></td></tr></table></div>

This function filters the dataframe such that the theme column contains "Hospitals".

<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">1
2
3</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">filter_by_hospitals_theme</span>(df) <span style="color: #333333">-&gt;</span> <span style="color: #007020">list</span>:
  <span style="color: #DD4422">&quot;&quot;&quot; only return rows with theme containing &#39;Hospitals&#39; &quot;&quot;&quot;</span>
  <span style="color: #008800; font-weight: bold">return</span> df<span style="color: #333333">.</span>filter(array_contains(df<span style="color: #333333">.</span>theme, <span style="background-color: #fff0f0">&#39;Hospitals&#39;</span>))
</pre></td></tr></table></div>



          <br><br>
          <h4>The column names in the csv headers are currently in mixed case with spaces and special characters. Convert all column names to snake_case. (Example: "Patients' rating of the faciilty linear mean score" becomes "patients_rating_of_the_facility_linear_mean_score").</h4>

<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">1
2
3
4
5
6
7
8</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">re</span>

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">cols_to_snake_case</span>(df) <span style="color: #333333">-&gt;</span> <span style="color: #008800; font-weight: bold">None</span>:
  <span style="color: #DD4422">&quot;&quot;&quot; convert column names to snake case &quot;&quot;&quot;</span>
  <span style="color: #008800; font-weight: bold">for</span> col <span style="color: #000000; font-weight: bold">in</span> df<span style="color: #333333">.</span>columns:
      new_col <span style="color: #333333">=</span> re<span style="color: #333333">.</span>sub(<span style="background-color: #fff0f0">r&quot;(?&lt;!^)(?=[A-Z])&quot;</span>, <span style="background-color: #fff0f0">&quot;_&quot;</span>, col)<span style="color: #333333">.</span>lower()
      df <span style="color: #333333">=</span> df<span style="color: #333333">.</span>withColumnRenamed(col, new_col)
  <span style="color: #008800; font-weight: bold">return</span> df
</pre></td></tr></table></div>

          <br><br>
          <h4>and the job should be designed to run every day,... </h4>

<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">schedule</span>
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">pytz</span> <span style="color: #008800; font-weight: bold">import</span> timezone
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">datetime</span>

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">job</span>():
  spark <span style="color: #333333">=</span> SparkSession<span style="color: #333333">.</span>builder<span style="color: #333333">.</span>getOrCreate()
  df <span style="color: #333333">=</span> spark<span style="color: #333333">.</span>createDataFrame(get_data())
  filtered <span style="color: #333333">=</span> filter_by_hospitals_theme(df)
  case_converted <span style="color: #333333">=</span> cols_to_snake_case(filtered)
  case_converted<span style="color: #333333">.</span>show()

schedule<span style="color: #333333">.</span>every()<span style="color: #333333">.</span>day<span style="color: #333333">.</span>at(<span style="background-color: #fff0f0">&quot;12:11:00&quot;</span>, timezone(<span style="background-color: #fff0f0">&quot;America/Chicago&quot;</span>))<span style="color: #333333">.</span>do(job)

<span style="color: #008800; font-weight: bold">while</span> <span style="color: #008800; font-weight: bold">True</span>:
  schedule<span style="color: #333333">.</span>run_pending()
  time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">30</span>)
</pre></td></tr></table></div>

          <br><br>
          <h4>but only download files that have been modified since the previous run (need to track runs/metadata).</h4>
        
        </div>


        <!-- 

             <div class="maincol_bottom"></div>
        <div class="maincol">          
        <h2>header</h2> 
        <p>All of the left and right columns have been created so that you can either have one continues box that goes all the way to the bottom, or several different boxes in each column, however you like it.  To make multiple columns, select the divs 'leftcol' and 'leftcol_bottom', copy, and paste the below the current ones (still inside of the 'leftcol_container' div).   This will create an exact copy of your column directly underneath your current one.  The left menu is an example of a long single div, while the right is multiple divs using the above method. <p>   This process is exactly the same for the main column (replace 'maincol' for 'leftcol') and the right as well ('rightcol' instead of 'leftcol').  The site looks good either way you do it, so experiment around with what works best for you.  The box below this one shows what an additional main column looks like (as opposed to a long single one)</p>
        </div>
        <div class="maincol_bottom"></div>
        </div>
        
        -->
        
     <div id="rightcol_container">
        
        
        <div class="rightcol">
        <h2>Categories</h2>
        	<ul>
            	<li><a href="#">Design</a></li>
            	<li><a href="#">Marketing</a></li>
            	<li><a href="#">SEO</a></li>
            	<li><a href="#">Graphics</a></li>
            	<li><a href="#">Flash</a></li>
            	<li><a href="#">Animation</a></li>
            </ul>
        </div>
        <div class="rightcol_bottom"></div>
        
        <div class="rightcol">
        <h2>Blogs</h2>
        	<ul>
            	<li><a href="#">John's Web design</a></li>
            	<li><a href="#">The Design Blog</a></li>
            	<li><a href="#">Designs4all</a></li>
            	<li><a href="#">Free XHTML Templates</a></li>
            	<li><a href="#">WebGraphics</a></li>
            	<li><a href="#">HowToWeb</a></li>
            </ul>
        </div>
        <div class="rightcol_bottom"></div>
        
        <div class="rightcol">
        <h2>Links</h2>
        	<ul>
            	<li><a href="#">Google</a></li>
            	<li><a href="#">Yahoo</a></li>
            	<li><a href="#">Bing</a></li>
            	<li><a href="#">Ask</a></li>
            	<li><a href="#">Dogpile</a></li>
            	<li><a href="#">Altavista</a></li>
            </ul>
        </div>
        <div class="rightcol_bottom"></div>
        
       <div class="rightcol">
        <h2>Most Recent</h2>
        	<ul>
            	<li><a href="#">Web Designers</a></li>
            	<li><a href="#">Internet Marketing</a></li>
            	<li><a href="#">Easy SEO</a></li>
            	<li><a href="#">Web Graphics</a></li>
            	<li><a href="#">Flash Animation</a></li>
            </ul>
        </div>
        <div class="rightcol_bottom"></div>
        
        
        </div>
        <div class="clear"></div>
        
         <div id="footer"><h3><a href="http://www.bryantsmith.com">web design florida</a></div>
  </div>

</div>
</body>
</html>
